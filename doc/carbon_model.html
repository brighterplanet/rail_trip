<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>carbon_model.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>carbon_model.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <p> Rail trip&rsquo;s carbon model is implemented using a domain-specific language
 provided by <a href="https://github.com/rossmeissl/leap">Leap</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;leap&#39;</span>

<span class="k">module</span> <span class="nn">BrighterPlanet</span>
  <span class="k">module</span> <span class="nn">RailTrip</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <h3>Rail trip: carbon model</h3>

<p> This module is used by <a href="http://brighterplanet.com">Brighter Planet</a>&rsquo;s
 <a href="http://carbon.brighterplanet.com">emission estimate service</a> to provide
 greenhouse gas emission estimates for rail trips.</p>

<p> For more information see:</p>

<ul>
<li> <a href="http://carbon.brighterplanet.com/rail_trips/options">API documentation</a></li>
<li> <a href="https://github.com/brighterplanet/rail_trip">Source code</a></li>
</ul>


<h4>Collaboration</h4>

<p> Contributions to this carbon model are actively encouraged and warmly welcomed.
 This library includes a comprehensive test suite to ensure that your changes
 do not cause regressions. All changes shold include test coverage for new
 functionality. Please see <a href="https://github.com/brighterplanet/sniff#readme">sniff</a>,
 our emitter testing framework, for more information.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">module</span> <span class="nn">CarbonModel</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <h4>The carbon model</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="o">::</span><span class="no">Leap</span><span class="o">::</span><span class="no">Subject</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p> This <code>decide</code> block encapsulates the carbon model. The carbon model is
 executed with a set of &ldquo;characteristics&rdquo; as input. These characteristics are
 parsed from input received by the client request according to the
 <a href="characterization.html">characterization</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">base</span><span class="o">.</span><span class="n">decide</span> <span class="ss">:emission</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="ss">:characteristics</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p> The emission committee returns a carbon emission estimate in kilograms CO2e.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:emission</span> <span class="k">do</span> <span class="c1"># returns kg CO2</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p> This calculation technique transforms amounts of diesel and electricity
 consumed during the rail trip&mdash;-via their current emission factors&mdash;-to
 an overall emission value. This value is divided by the passenger count
 to obtain a per-passenger emission share.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from fuel and passengers&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:diesel_consumed</span><span class="p">,</span> <span class="ss">:electricity_used</span><span class="p">,</span> <span class="ss">:passengers</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>((       litres diesel         ) * (  kilograms CO2 / litre diesel   ) + (           kwH                  ) * (     kilograms CO2 / kWh               ))</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="p">(</span><span class="n">characteristics</span><span class="o">[</span><span class="ss">:diesel_consumed</span><span class="o">]</span> <span class="o">*</span> <span class="no">RailTrip</span><span class="o">.</span><span class="n">rail_trip_model</span><span class="o">.</span><span class="n">research</span><span class="p">(</span><span class="ss">:diesel_emission_factor</span><span class="p">)</span> <span class="o">+</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:electricity_used</span><span class="o">]</span> <span class="o">*</span> <span class="no">RailTrip</span><span class="o">.</span><span class="n">rail_trip_model</span><span class="o">.</span><span class="n">research</span><span class="p">(</span><span class="ss">:electricity_emission_factor</span><span class="p">))</span> <span class="o">/</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:passengers</span><span class="o">]</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p> Generally the client will not know the exact amount of diesel consumed
 during the rail trip, so it must be calculated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:diesel_consumed</span> <span class="k">do</span> <span class="c1"># returns litres diesel</span>
            </pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p> This technique uses trip distance and fuel efficiency to determine diesel
 consumption.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from distance and diesel intensity&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:distance</span><span class="p">,</span> <span class="ss">:diesel_intensity</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p>(          kilometres        ) * (     litres diesel / kilometre      )</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:distance</span><span class="o">]</span> <span class="o">*</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:diesel_intensity</span><span class="o">]</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p> Similarly, electricity consumption will typically be computed here.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:electricity_used</span> <span class="k">do</span> <span class="c1"># returns kWh</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <p> As with diesel consumption, we calculate electricity use by multiplying
 distance by &ldquo;electric intensity&rdquo;&mdash;&ndash; an analogue of fuel efficiency.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from distance and electricity intensity&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:distance</span><span class="p">,</span> <span class="ss">:electricity_intensity</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p>(       kilometres           ) * (         kWh / kilometre                  )</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:distance</span><span class="o">]</span> <span class="o">*</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:electricity_intensity</span><span class="o">]</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p> The distance of the rail trip is necessary to perform each of the above
 calculations and can be calculated using several methods.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:distance</span> <span class="k">do</span> <span class="c1"># returns kilometres</span>
            </pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p> The primary distance-calculation method is directly accepting an estimate from
 the client.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from distance estimate&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:distance_estimate</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:distance_estimate</span><span class="o">]</span>
            <span class="k">end</span>
            </pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p> Alternatively we can calculate distance by combining an estimate of trip
 duration with the train&rsquo;s average speed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from duration&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:duration</span><span class="p">,</span> <span class="ss">:speed</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        <p>(       hours           ) * (        kph          )</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:duration</span><span class="o">]</span> <span class="o">*</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:speed</span><span class="o">]</span>
            <span class="k">end</span>
            </pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p> Finally, we can assume the trip covered an average distance, scoped by
 its rail class (subway vs. intercity, for example).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from rail class&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:rail_class</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:rail_class</span><span class="o">].</span><span class="n">distance</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        <p> Diesel intensity is analogous to fuel efficiency (mpg), but are expressed
 in units of fuel per unit of distance.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:diesel_intensity</span> <span class="k">do</span> <span class="c1"># returns litres diesel / vehicle kilometre</span>
            </pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        <p> Brighter Planet has pre-calculated intensities for popular rail classes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from rail class&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:rail_class</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:rail_class</span><span class="o">].</span><span class="n">diesel_intensity</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        <p> Electricity intensity describes the amount of electric power consumed per
 unit of train travel distance.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:electricity_intensity</span> <span class="k">do</span> <span class="c1"># returns kWh / vehicle kilometre</span>
            </pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
        <p> Again, intensities have been pre-calculated for popular rail classes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from rail class&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:rail_class</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:rail_class</span><span class="o">].</span><span class="n">electricity_intensity</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
        <p> Speed is only necessary when used in combination with trip (temporal)
 duration to determine distance.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:speed</span> <span class="k">do</span> <span class="c1"># returns kph</span>
            </pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
        <p> Rail classes provide average speed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from rail class&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:rail_class</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:rail_class</span><span class="o">].</span><span class="n">speed</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-25">#</a>
        </div>
        <p> Each passenger is responsible for a share of the train trip&rsquo;s total
 footprint.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:passengers</span> <span class="k">do</span>
            </pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-26">#</a>
        </div>
        <p> A passenger count can be gleaned from popular rail classes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from rail class&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:rail_class</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:rail_class</span><span class="o">].</span><span class="n">passengers</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-27">#</a>
        </div>
        <p> The vehicle used for a rail trip can be meaningfully assigned to one
 of a list of categories called classes, including subways, intercity
 rail, and commuter rail, for example.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:rail_class</span> <span class="k">do</span>
            </pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-28">#</a>
        </div>
        <p> If the client does not provide a rail class, we use an artificial
 rail class, constructed using a weighted average approach.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;default&#39;</span> <span class="k">do</span>
              <span class="no">RailClass</span><span class="o">.</span><span class="n">fallback</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    </table>
</div>
</body>
